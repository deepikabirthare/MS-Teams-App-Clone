

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> public/script.js</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                <div class="dropdown is-hoverable is-right">
                    <a class="dropdown-trigger link">
                        Tutorials
                        <i class="fas fa-chevron-down fa-xs"></i>
                    </a>
                    <div class="dropdown-menu">
                        <div class="dropdown-content">
                        
                            <a class="dropdown-item" href="tutorial-CodeArchitecture.html">
                                CodeArchitecture
                            </a>
                        
                            <a class="dropdown-item" href="tutorial-What-I-Learned.html">
                                What-I-Learned
                            </a>
                        
                        </div>
                    </div>
                </div>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
                <div class="search-wrapper">
                    <input id="search" type="text" placeholder="Search docs..." class="input">
                </div>
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3><a href="global.html">Global</a></h3></div><div class="category"><h2>Index.js</h2><h3>Global</h3><ul><li><a href="global.html#express">express</a></li><li><a href="global.html#io">io</a></li></ul></div><div class="category"><h2>Script.js</h2><h3>Global</h3><ul><li><a href="global.html#addVideoStream">addVideoStream</a></li><li><a href="global.html#chatWindow">chatWindow</a></li><li><a href="global.html#configuration">configuration</a></li><li><a href="global.html#connectToNewUser">connectToNewUser</a></li><li><a href="global.html#copy">copy</a></li><li><a href="global.html#getUserName">getUserName</a></li><li><a href="global.html#muteUnmute">muteUnmute</a></li><li><a href="global.html#peers">peers</a></li><li><a href="global.html#playStop">playStop</a></li><li><a href="global.html#scrollToBottom">scrollToBottom</a></li><li><a href="global.html#setMuteButton">setMuteButton</a></li><li><a href="global.html#setPlayVideo">setPlayVideo</a></li><li><a href="global.html#setStopVideo">setStopVideo</a></li><li><a href="global.html#setUnmuteButton">setUnmuteButton</a></li><li><a href="global.html#socket">socket</a></li><li><a href="global.html#videoGrid">videoGrid</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>public/script.js</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
*imported socket.io for real time communication
*@category Script.js
*/
const socket = io('/')

////////////////////////////////////////////////////////////////
/**
*stun and turn servers used for the peer to peer connection
*credentials for turn server are provided by xirsys.
*stun servers used are provided by google.
* @category Script.js
*/
var configuration = { iceServers: [{
  urls: "stun:stun.services.mozilla.com",
  username: "louis@mozilla.com",
  credential: "webrtcdemo"
}, {
  urls: [
          "stun:stun.example.com",
          "stun:stun-1.example.com"
  ]
}, { urls: "stun:stun1.l.google.com:19302" },
{ urls: "stun:stun2.l.google.com:19302" },
{ urls: "stun:stun3.l.google.com:19302" },
{ urls: "stun:stun4.l.google.com:19302" },
{ urls: "stun:stun01.sipphone.com" },
{ urls: "stun:stun.l.google.com:19302" },
{ urls:  "stun:bn-turn1.xirsys.com" },
{
  username: "jLpyhSW_Zr7lqqNE6sFytfEDTXabyWTc7wKUducRf0ME6UQIB8EofrpdSTSBheMbAAAAAGDSSRFzaHViaGFtYW1zYQ==",
  credential: "15c32c6e-d399-11eb-84f0-0242ac140004",
  urls: [
      "turn:bn-turn1.xirsys.com:80?transport=udp",
      "turn:bn-turn1.xirsys.com:3478?transport=udp",
      "turn:bn-turn1.xirsys.com:80?transport=tcp",
      "turn:bn-turn1.xirsys.com:3478?transport=tcp",
      "turns:bn-turn1.xirsys.com:443?transport=tcp",
      "turns:bn-turn1.xirsys.com:5349?transport=tcp"
  ]
}
]
};

///////////////////////////////////////////////////////////////////////////////////////////
var user
/**
*function takes the username input through prompt
*and sets the user variable to obtained username
*function uses bootbox library to generate prompt
* @category Script.js
*/
function getUserName(){
  var box = bootbox.prompt({
      closeButton: false,
      title: "Enter your name or leave blank to chat as Anonymous user",
      centerVertical: true,
      callback: function(result){
        user = result;
        if(user === "" || user === null || user === undefined)
          user = "Anonymous";
      }
  });
  box.find('.modal-content').css({'background': 'rgba(43,43,43,0.4)'});
  box.find('.modal-header').css({'color': '#E8F0F2'});
  box.find(".btn-primary").removeClass("btn-primary").addClass("btn-outline-primary");
  box.find(".btn-secondary").removeClass("btn-secondary").addClass("btn-outline-secondary");
  box.find('input').css({'background-color': 'rgba(43,43,43,0.4)'})
  box.find('input').css({'color': '#E8F0F2'})

}
////////////////////////////////////////////////////////////////

/**
*created a Peer type object for peer to peer communication
* I hosted my own peerjs server on heroku for the purpose
* @typedef {Object} Peer
* @property {string} host "dbpeerjsserver.herokuapp.com", my own peerjs server
* @property {number} port  443 for https requests
* @property {boolean} secure it's a secure port
* @property {object} config iceServers (stun and turns servers)
* @catagory Script.js
*/
var myPeer = new Peer(undefined, {
  host: "dbpeerjsserver.herokuapp.com",
  port: 443,
  secure: true,
  config: configuration
});

///////////////////////////////////////////////////////////////////////////
/**
*variable to store video element
*@category Script.js
*/
const videoGrid = document.getElementById('video-grid')
const myVideo = document.createElement('video')
var myId;
myVideo.muted = true

/**
* array to store unique user Ids and call object
*@category Script.js
*/
var peers = {}
let myVideoStream;
navigator.mediaDevices.getUserMedia({
  video: true,
  audio: true
}).then(stream => {
  myVideoStream = stream;
  var uCall;
  var uVid;
  addVideoStream(myVideo, stream);

  /**
  *answering the call by providing our audio and video stream
  *@category Script.js
  */
  myPeer.on('call', (call) => {
    uCall = call;
    call.answer(stream);
    call.on('stream', userVideoStream => {
      uVid = userVideoStream;
    })
  })

  /**
  * when connection is established this function will store the userId
  * and call object of the user who called.
  * @category Script.js
  */
  myPeer.on('connection', (conn) => {
      conn.on('data', (myId) => {
        peers[myId] = uCall;
        const video = document.createElement('video');
        video.setAttribute("id", myId);
        addVideoStream(video, uVid);
    })
  })

  /**
  * listens to the event 'user-connected'
  * if event occurs then call the connectToNewUser() function
  *@category Script.js
  */
  socket.on('user-connected', userId => {
    connectToNewUser(userId, stream);
  })

  /**
  * takes the text messages as input
  *@category Script.js
  */
  let text = $('input');

 /**
 *when enter is pressed send the message
 *@category Script.js
 */
  $('html').keydown((e) => {
    if (e.which == 13 &amp;&amp; text.val().length !== 0) {
      $('ul').append(`&lt;li class="message">&lt;b>You: &lt;/b>${text.val()}&lt;/li>`);
      scrollToBottom();
      /**
      * emits the event 'message' so that server can listen to it
      * sends the username along with text message to server
      *@category Script.js
      */
      socket.emit('message', user, text.val());
      text.val('');
    }
  });
  /**
  * listens to event 'createMessage' emitted by server
  * and appends the message sent by user to list of
  * messages in chat window.
  * @category Script.js
  */
  socket.on('createMessage', (userName, message) => {
    $('ul').append(`&lt;li class="message">&lt;b>${userName}: &lt;/b>${message}&lt;/li>`);
    scrollToBottom();
  });
});

////////////////////////////////////////////////////////////////

/**
* listens to event 'user-disconnected' and
* closes the call and removes the video and video grid of user
* @category Script.js
*/
socket.on('user-disconnected', userId => {
  if (peers[userId])  {
    peers[userId].close();
    var userVideo = document.getElementById(userId);
    if(userVideo !== null)
      userVideo.remove();
  }
});

/**
*when connection to peerjs server is established it emits the event to join room
* by passing unique ROOM_ID and userId.
* @category Script.js
*/
myPeer.on('open', id => {
  myId = id;
  socket.emit('join-room', ROOM_ID, id);
});

////////////////////////////////////////////////////////////////

/**
*called when 'user-connected' event is emitted
*this function is used to call the new user that connected
*by sending the stream of the user who is calling.
*This function also strores the call object in peers array
*@param {object} stream we send our own audio and video stream to connect
*@param {string} userId id of the user we want to connect to
*@category Script.js
*/

function connectToNewUser(userId, stream) {
  const call = myPeer.call(userId, stream);
  const conn = myPeer.connect(userId);
  conn.on('open', () => {
    conn.send(myId);
  });
  const video = document.createElement('video');
  video.setAttribute("id", userId);
  call.on('stream', userVideoStream => {
    addVideoStream(video, userVideoStream);
  });
  call.on('close', () => {
    video.remove();
  });
  peers[userId] = call;
}

///////////////////////////////////////////////////////////////

/**
*function addVideoStream adds the video element to the video-grid
*videoGrid is the div container used to hold the video stream
*@param {media} video video of the user accessed from the device
*@param {object} stream MediaStream object
*@category Script.js
*/
function addVideoStream(video, stream) {
  video.srcObject = stream;
  video.addEventListener('loadedmetadata', () => {
    video.play();
  });
  videoGrid.append(video);
}

///////////////////////////////////////////////////////////////

/**
*copies the ROOM_ID to share with different users to join a room
* @category Script.js
*/
function copy(){
  var input = document.createElement('input');
  input.setAttribute('value', ROOM_ID);
  document.body.appendChild(input);
  input.select();
  var result = document.execCommand('copy');
  document.body.removeChild(input);
  var box = bootbox.alert({
      message: "Copied",
      closeButton: false,
  });
  box.find('.modal-content').css({'background': 'rgba(43,43,43,0.4)'});
  box.find('.modal-content').css({'color': '#E8F0F2'});
  box.find(".btn-primary").removeClass("btn-primary").addClass("btn-outline-primary");
  box.find('.modal-content').css({'width': '40%'});
  box.find('.modal-body').css({'height': '20px'});
  box.find('.modal-footer').css({'border-style': 'none'});

}

////////////////////////////////////////////////////////////////

/**
*scrolls to bottom as chat window gets filled
*@category Script.js
*/
const scrollToBottom = () => {
  var d = $('.main_chat_window');
  d.scrollTop(d.prop("scrollHeight"));
}

/**
*toggles the mute and unmute button
*if audio is true the mutes it else unmutes it
*@category Script.js
*/
const muteUnmute = () => {
  const enabled = myVideoStream.getAudioTracks()[0].enabled;
  if (enabled) {
    myVideoStream.getAudioTracks()[0].enabled = false;
    setUnmuteButton();
  } else {
    myVideoStream.getAudioTracks()[0].enabled = true;
    setMuteButton();
  }
}

/**
*to stop and play Video as user clicks to stop Video or play Video
*@category Script.js
*/
const playStop = () => {
  let enabled = myVideoStream.getVideoTracks()[0].enabled;
  if (enabled) {
    myVideoStream.getVideoTracks()[0].enabled = false;
    setPlayVideo();
  } else {
    myVideoStream.getVideoTracks()[0].enabled = true;
    setStopVideo();
  }
}

/**
*hides and show the main chat Window as user toggles the hide and display button
*@category Script.js
*/
const chatWindow = () => {
  styleType = $(".main_right").css("display");
  if(styleType == "flex")
    $(".main_right").css("display","none");
  else
    $(".main_right").css("display","flex");
}

const disconnectUser = () => {
  window.close();
}

/**
*changes inner html of mute button
*@category Script.js
*/
const setMuteButton = () => {
  const html = `
    &lt;i class="fas fa-microphone">&lt;/i>
    &lt;span>Mute&lt;/sapn>
  `
  document.querySelector('.main_mute_button').innerHTML = html;
}

/**
*changes inner html of unmute button
*@category Script.js
*/
const setUnmuteButton = () => {
  const html = `
    &lt;i class="unmute fas fa-microphone-slash">&lt;/i>
    &lt;span>Unmute&lt;/span>
  `
  document.querySelector('.main_mute_button').innerHTML = html;
}

/**
*changes inner html of Stop video button
*@category Script.js
*/
const setStopVideo = () => {
  const html = `
    &lt;i class="fas fa-video">&lt;/i>
    &lt;span>Stop Video&lt;/span>
  `
  document.querySelector('.main_video_button').innerHTML = html;
}

/**
*changes inner html of play video button
*@category Script.js
*/
const setPlayVideo = () => {
  const html = `
  &lt;i class="stop fas fa-video-slash">&lt;/i>
    &lt;span>Show Video&lt;/span>
  `
  document.querySelector('.main_video_button').innerHTML = html;
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

<script src="scripts/search.js"> </script>

</body>
</html>
